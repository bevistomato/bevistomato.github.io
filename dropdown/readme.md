# 在背后不可忽略的逻辑——DIY单选多选框

最近在工程中前端的同事编码时遇到的一些问题“实现的控件样式好看，但是实际体验不好，显示效果常出现意料之外的情况，BUG频出”。这帮助他修bug的同时也促使我最近一直在思考一个问题，作为一个HTML工程师，要实现一些DIY控件，很多时候重心都放在让控件样式优美这类可以直观感受的指标上，隐藏在背后的指标很容易就被忽略——封闭而完备的状态转移逻辑。

BUG频繁出现，最根本的原因就是代码的逻辑并不完备。如何才能如何实现代码才能确保逻辑完备，并没有一套100%通用的方法。因此，打算从这篇笔记开始，记录下问题思考的轨迹，解决问题过程中抽象的模型，状态自动机的转移过程等等，以备将来迭代优化时使用。

 

## 一、单选框和多选框的异同
单选框：
多选框：


### 相同点：
它们都是由一个文本输入框和一个备选词框构成。文本输入框都显示当前已经选择的内容。都可以直接在框中输入文字检索。都可以直接点击选定备选词框中符合要求的候选词。此外，当输入内容和备选内容一致时，都可以自动选定备选内容。非输入状态下，备选词框不可见。


### 不同点：
单选框只能选一个词，多选框可以选多个。

从上面的对比来看，单选框和多选框绝大部分都是相同的，只有可选词数目不同而已。因此，在模型抽象时，可以把两者合二为一，从而简化分析和编码的难度。

## 二、模型
从相同点分析中可以得出，框架模型由一个文本输入框（text）和一个列表（list）备选词框构成，list存在显示和隐藏两种状态（1显示/0隐藏，是否显示list由text是否有是否有焦点决定）。

事件模型（状态转移）包括：1、响应text的input事件（keyup事件在粘贴时失效），触发备选词变更。2、tap和click事件，触发选定和取消候选词。3、text的focus/blur事件，触发备选词的显示/隐藏。

从不同点分析，模型需要一个状态当前在编辑的候选词，由于已经选定和正在编辑的候选词，都在text中显示着，所以可以使用selectionStart获取的光标的位置才计算当前正在编辑的候选词。（对于单选框而言，正在编辑的候选词只能是第一个词。多选框不一样，可以编辑“，”之间的任何一个候选词）。

## 三、状态转移过程

焦点 | 编辑词 | 词数 | 事件（所有输入词语集合I，所有选项集合C，点击词语T） | 转移至 | 焦点 | 编辑词 | 词数 | 说明
--- |  ---   | ---  | ----------------------------------------------  | ----- | ---- | ----- | ---- | ---
 0  |  Null  | N    | Text.click                                      |       | 1    |  Y    | N    | 激活控件进入输入状态，
 1  |  X     | N    | Text.click                                      |       | 1    |  Y    | N    | 更改光标位置，变更编辑词
 1  |  X     | N    | List.click, T ∈ I                              |       |  1   |   Y   | N - 1 | 去掉输入词中包含的T
    |        |      | List.click,T∉I,X≠T,X∈C                         |       |  1   |  X    | N+1   | I集合中新增一个词T
    |        |      | List.click,T∉I,X≠T,X∉C                          |       | 1    | T     | N     | I集合中将X替换成T
    |        |      | Text.Input                                      |       |  1   |  Y     | N     | 词语X变更成新的词语Y
    |        |      | Text.input 分隔符（，、）                        |       |  1   |  Y     | N+1   | 输入分隔符，新增加一个词语
 1  |   X    | N    | (Other Elem).click                             |        | 0    | Null   | M    | 控件失焦，退出输入状态，求I和C的交集，作为最终选词
 
 

